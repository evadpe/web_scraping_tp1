# run_advanced_scraper.py
import sys
import os
from scrapy.crawler import CrawlerProcess
import csv
from datetime import datetime

def run_advanced_scraper():
    """Lance le scraper avanc√© pour extraire toutes les donn√©es des joueurs"""
    print("üèê SCRAPER FFVB AVANC√â - STATS COMPL√àTES DES JOUEURS")
    print("=" * 60)
    print("üéØ Objectifs:")
    print("   ‚úì Extraire noms, num√©ros, postes")
    print("   ‚úì Collecter statistiques d√©taill√©es")
    print("   ‚úì R√©cup√©rer historique des comp√©titions")
    print("   ‚úì Naviguer vers pages de stats individuelles")
    print("   ‚úì Analyser tableaux de r√©sultats")
    print("   ‚úì Extraire informations biographiques")
    print()
    print("üìÅ Fichiers g√©n√©r√©s:")
    print("   - ffvb_players_complete.csv (format tableau)")
    print("   - ffvb_players_complete.json (format structur√©)")
    print()
    
    # Configuration Scrapy avanc√©e
    settings = {
        'BOT_NAME': 'ffvb_advanced',
        'ROBOTSTXT_OBEY': True,
        'DOWNLOAD_DELAY': 2,  # Respectueux du serveur
        'RANDOMIZE_DOWNLOAD_DELAY': 0.5,
        'LOG_LEVEL': 'INFO',
        'USER_AGENT': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        
        # Gestion des erreurs et retry
        'RETRY_TIMES': 3,
        'RETRY_HTTP_CODES': [500, 502, 503, 504, 408, 429, 403],
        'RETRY_PRIORITY_ADJUST': -1,
        
        # Performance optimis√©e
        'CONCURRENT_REQUESTS': 1,  # S√©quentiel pour √™tre respectueux
        'CONCURRENT_REQUESTS_PER_DOMAIN': 1,
        'AUTOTHROTTLE_ENABLED': True,
        'AUTOTHROTTLE_START_DELAY': 1,
        'AUTOTHROTTLE_MAX_DELAY': 5,
        'AUTOTHROTTLE_TARGET_CONCURRENCY': 1.0,
        
        # Gestion des redirections
        'REDIRECT_ENABLED': True,
        'REDIRECT_MAX_TIMES': 5,
        
        # Headers plus r√©alistes
        'DEFAULT_REQUEST_HEADERS': {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'fr-FR,fr;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate',
            'DNT': '1',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
        },
        
        # Pas de cache pour donn√©es fra√Æches
        'HTTPCACHE_ENABLED': False,
        
        # Dur√©e de vie du scraper
        'CLOSESPIDER_TIMEOUT': 1800,  # 30 minutes max
        'CLOSESPIDER_ITEMCOUNT': 50,  # Max 50 joueurs (s√©curit√©)
        
        # Export en temps r√©el
        'FEEDS': {
            'ffvb_players_realtime.jsonl': {
                'format': 'jsonlines',
                'encoding': 'utf8',
                'store_empty': False,
            },
        },
        
        # Middlewares personnalis√©s
        'DOWNLOADER_MIDDLEWARES': {
            'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware': None,
            'scrapy.downloadermiddlewares.retry.RetryMiddleware': 90,
            'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware': 110,
        },
    }
    
    # Ajouter le r√©pertoire actuel au PYTHONPATH
    current_dir = os.getcwd()
    if current_dir not in sys.path:
        sys.path.insert(0, current_dir)
    
    process = CrawlerProcess(settings)
    
    try:
        from ffvb_scraper.spiders.ffvb_advanced_player_scraper import FFVBAdvancedPlayerSpider
        
        print("üï∑Ô∏è  D√©marrage du scraper avanc√©...")
        print("‚è≥ PATIENCE - Extraction compl√®te en cours...")
        print("üìä Le scraper va :")
        print("   1. Identifier tous les joueurs")
        print("   2. Visiter leur page individuelle")
        print("   3. Chercher leurs pages de statistiques")
        print("   4. Extraire toutes les donn√©es disponibles")
        print()
        
        process.crawl(FFVBAdvancedPlayerSpider)
        process.start()
        
        print()
        print("‚úÖ EXTRACTION AVANC√âE TERMIN√âE!")
        print("=" * 40)
        
        # Analyser les r√©sultats
        results_summary = analyze_results()
        print(results_summary)
        
        print()
        print("üîç ANALYSEZ VOS DONN√âES:")
        print("1. üìä Ouvrez ffvb_players_complete.csv dans Excel/LibreOffice")
        print("2. üîß Utilisez ffvb_players_complete.json pour traitement automatis√©")
        print("3. üìà V√©rifiez la compl√©tude des statistiques extraites")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Erreur d'import: {e}")
        print("üí° V√©rifiez la structure des r√©pertoires:")
        print("   ffvb_scraper/")
        print("   ‚îî‚îÄ‚îÄ spiders/")
        print("       ‚îî‚îÄ‚îÄ ffvb_advanced_player_scraper.py")
        return False
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def analyze_results():
    """Analyse les r√©sultats de l'extraction"""
    summary = []
    
    try:
        # Analyser le fichier CSV
        if os.path.exists('ffvb_players_complete.csv'):
            with open('ffvb_players_complete.csv', 'r', encoding='utf-8') as f:
                lines = list(f)
                players_count = len(lines) - 1  # -1 pour l'en-t√™te
            
            summary.append(f"üìä R√âSULTATS D'EXTRACTION:")
            summary.append(f"   ‚îî‚îÄ‚îÄ Joueurs trouv√©s: {players_count}")
            
            if players_count > 0:
                # Analyser quelques lignes pour voir la compl√©tude
                import csv
                with open('ffvb_players_complete.csv', 'r', encoding='utf-8') as f:
                    reader = csv.DictReader(f)
                    first_player = next(reader, None)
                    
                    if first_player:
                        filled_fields = sum(1 for v in first_player.values() if v.strip())
                        total_fields = len(first_player)
                        completeness = (filled_fields / total_fields) * 100
                        
                        summary.append(f"   ‚îî‚îÄ‚îÄ Compl√©tude des donn√©es: {completeness:.1f}%")
                        summary.append(f"   ‚îî‚îÄ‚îÄ Champs remplis: {filled_fields}/{total_fields}")
                        
                        # Afficher quelques donn√©es d'exemple
                        summary.append(f"   ‚îî‚îÄ‚îÄ Exemple: {first_player.get('nom_joueur', 'N/A')} "
                                     f"(#{first_player.get('numero', 'N/A')}) - "
                                     f"{first_player.get('poste', 'N/A')}")
        
        # Analyser le fichier JSON
        if os.path.exists('ffvb_players_complete.json'):
            size = os.path.getsize('ffvb_players_complete.json')
            summary.append(f"üìÑ Fichier JSON: {size:,} bytes")
        
        # Analyser le fichier temps r√©el
        if os.path.exists('ffvb_players_realtime.jsonl'):
            with open('ffvb_players_realtime.jsonl', 'r', encoding='utf-8') as f:
                realtime_count = sum(1 for line in f)
            summary.append(f"‚ö° Extraction temps r√©el: {realtime_count} √©l√©ments")
    
    except Exception as e:
        summary.append(f"‚ö†Ô∏è  Erreur analyse r√©sultats: {e}")
    
    return '\n'.join(summary)

def preview_data():
    """Affiche un aper√ßu des donn√©es extraites"""
    print("\nüîç APER√áU DES DONN√âES EXTRAITES:")
    print("=" * 40)
    
    try:
        if os.path.exists('ffvb_players_complete.csv'):
            import csv
            with open('ffvb_players_complete.csv', 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                players = list(reader)
            
            if players:
                print(f"üìä {len(players)} joueur(s) extrait(s)")
                print()
                
                # Afficher les 3 premiers joueurs
                for i, player in enumerate(players[:3], 1):
                    print(f"üèê JOUEUR {i}:")
                    print(f"   Nom: {player.get('nom_joueur', 'N/A')}")
                    print(f"   Num√©ro: {player.get('numero', 'N/A')}")
                    print(f"   Poste: {player.get('poste', 'N/A')}")
                    print(f"   Taille: {player.get('taille', 'N/A')}")
                    print(f"   Club: {player.get('club_actuel', 'N/A')}")
                    print(f"   S√©lections: {player.get('selections', 'N/A')}")
                    print(f"   Matches: {player.get('matches_joues', 'N/A')}")
                    
                    # Comp√©titions
                    competitions = player.get('competitions', '')
                    if competitions:
                        comp_list = competitions.split(' | ')[:3]  # 3 premi√®res
                        print(f"   Comp√©titions: {', '.join(comp_list)}")
                    
                    # Stats
                    if player.get('victoires') and player.get('defaites'):
                        print(f"   Bilan: {player['victoires']}V - {player['defaites']}D")
                    
                    print()
                
                # Statistiques g√©n√©rales
                print("üìà STATISTIQUES G√âN√âRALES:")
                fields_analysis = analyze_field_completeness(players)
                for field, percentage in fields_analysis.items():
                    if percentage > 0:
                        print(f"   {field}: {percentage:.1f}% compl√©t√©")
            
            else:
                print("‚ùå Aucun joueur trouv√© dans le fichier CSV")
        
        else:
            print("‚ùå Fichier ffvb_players_complete.csv non trouv√©")
    
    except Exception as e:
        print(f"‚ùå Erreur lors de l'aper√ßu: {e}")

def analyze_field_completeness(players):
    """Analyse la compl√©tude de chaque champ"""
    if not players:
        return {}
    
    field_stats = {}
    total_players = len(players)
    
    # Champs √† analyser
    important_fields = {
        'nom_joueur': 'Nom',
        'numero': 'Num√©ro', 
        'poste': 'Poste',
        'taille': 'Taille',
        'club_actuel': 'Club',
        'selections': 'S√©lections',
        'matches_joues': 'Matches',
        'victoires': 'Victoires',
        'competitions': 'Comp√©titions'
    }
    
    for field_key, field_name in important_fields.items():
        filled_count = sum(1 for player in players if player.get(field_key, '').strip())
        percentage = (filled_count / total_players) * 100
        field_stats[field_name] = percentage
    
    return field_stats

def create_summary_report():
    """Cr√©e un rapport de synth√®se"""
    print("\nüìã CR√âATION DU RAPPORT DE SYNTH√àSE...")
    
    try:
        if not os.path.exists('ffvb_players_complete.csv'):
            print("‚ùå Fichier de donn√©es non trouv√©")
            return
        
        import csv
        from datetime import datetime
        
        with open('ffvb_players_complete.csv', 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            players = list(reader)
        
        # Cr√©er le rapport
        report_filename = f'ffvb_rapport_synthese_{datetime.now().strftime("%Y%m%d_%H%M%S")}.txt'
        
        with open(report_filename, 'w', encoding='utf-8') as f:
            f.write("üèê RAPPORT DE SYNTH√àSE - √âQUIPE DE FRANCE MASCULINE VOLLEY\n")
            f.write("=" * 60 + "\n\n")
            f.write(f"Date d'extraction: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\n")
            f.write(f"Nombre de joueurs: {len(players)}\n\n")
            
            # Analyse par poste
            postes = {}
            for player in players:
                poste = player.get('poste', 'Non d√©fini').strip()
                if poste:
                    postes[poste] = postes.get(poste, 0) + 1
            
            if postes:
                f.write("üìä R√âPARTITION PAR POSTE:\n")
                for poste, count in sorted(postes.items()):
                    f.write(f"   {poste}: {count} joueur(s)\n")
                f.write("\n")
            
            # Liste des joueurs
            f.write("üë• LISTE DES JOUEURS:\n")
            for player in players:
                nom = player.get('nom_joueur', 'N/A')
                numero = player.get('numero', 'N/A')
                poste = player.get('poste', 'N/A')
                club = player.get('club_actuel', 'N/A')
                
                f.write(f"#{numero:>2} - {nom:<25} ({poste:<15}) - {club}\n")
            
            f.write(f"\nüìÑ Rapport sauvegard√©: {report_filename}\n")
        
        print(f"‚úÖ Rapport cr√©√©: {report_filename}")
    
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation rapport: {e}")

if __name__ == "__main__":
    success = run_advanced_scraper()
    
    if success:
        # Afficher aper√ßu des donn√©es
        preview_data()
        
        # Cr√©er rapport de synth√®se
        create_summary_report()
        
        print("\nüéâ EXTRACTION TERMIN√âE AVEC SUCC√àS!")
        print("\nüí° PROCHAINES √âTAPES POSSIBLES:")
        print("1. üñºÔ∏è  Extraction OCR des images CV pour plus de d√©tails")
        print("2. üìà Analyse des tendances et statistiques")
        print("3. üîÑ Automatisation p√©riodique pour mise √† jour")
        print("4. üìä Cr√©ation de visualisations des donn√©es")
    
    else:
        print("\n‚ùå √âCHEC DE L'EXTRACTION")
        print("\nüîß SOLUTIONS POSSIBLES:")
        print("1. V√©rifiez votre connexion internet")
        print("2. V√©rifiez la structure des r√©pertoires")
        print("3. Installez les d√©pendances manquantes")
        print("4. Utilisez la version Selenium si probl√®me JavaScript")